"use strict";$(function(){function e(e){var n=e.length;$("#pin-total").text(n);var t=e.pop(),a=0;$("#pin").text(t),$("#pin-input").bind("GET_PIN",function(i){i.target.value!=t?(i.target.value="",$("#pin-form").addClass("has-error"),$(".form-control-feedback").removeClass("hidden"),v.emit("rollback",{pin:t,sampleID:p.sampleID}),c(),console.log("Wrong PIN! Send rollback message! Remove sensor listener")):(i.target.value="",$("#pin-form").removeClass("has-error"),$(".form-control-feedback").addClass("hidden"),t=e.pop(),a+=1,$("#pin-progress").css("width",a/n*100+"%"),$("#pin").text(t),$("#pin-count").text(a),a==n&&($("#pin-input").attr("disabled","disabled").unbind("GET_PIN"),o(),$("#overModal").modal("show"),$("#enter-again-btn").click(function(e){window.location.reload()})))})}function n(){r(),t(),$("#pin-input").keyup(function(e){4==e.target.value.length&&$("#pin-input").trigger("GET_PIN",e)})}function t(){$("#startupModal").modal("show").on("hide.bs.modal",function(e){var n=$("#username").val();""!=n&&(p.username=n)})}function o(){v.emit("log-complete",{sampleID:p.sampleID,username:p.username,pinsCount:p.pinsCount,UAParser:m.getResult()})}function a(e){return new Promise(function(n,t){$.ajax({method:"GET",url:e,dataType:"jsonp"}).done(function(e){var t=i(e.pins);n(t)})})}function i(e){for(var n=1;n<e.length;n++){var t=Math.floor(Math.random()*(n+1)),o=e[n];e[n]=e[t],e[t]=o}return e}function r(){window.DeviceMotionEvent&&window.DeviceOrientationEvent?$("#pin-input").bind("focus",function(){s()}).bind("blur",function(){c()}):$("#browser-alert").removeClass("hidden")}function c(){window.removeEventListener("devicemotion",u,!1),window.removeEventListener("deviceorientation",d,!1)}function s(){window.addEventListener("devicemotion",u,!1),window.addEventListener("deviceorientation",d,!1)}function l(e){v.emit("sensor",{username:p.username,sampleID:p.sampleID,pin:$("#pin").text(),time:new Date,data:e})}function u(e){var n=e.acceleration,t=e.accelerationIncludingGravity,o=e.rotationRate,a=e.interval,i={"acc-x":n.x,"acc-y":n.y,"acc-z":n.z,"gacc-x":t.x,"gacc-y":t.y,"gacc-z":t.z,"rot-alpha":o.alpha,"rot-beta":o.beta,"rot-gamma":o.gamma,interval:a};l(i)}function d(e){var n={"ox-gamma":e.gamma,"oy-beta":e.beta,"oz-alpha":e.alpha};l(n)}var p={pinURL:"http://115.159.83.89:8080/pin",serverURL:"http://115.159.83.89:8080",username:"Anonymous",sampleID:(new Date).getTime()},m=new UAParser,v=io.connect(p.serverURL);v.on("connect_error",function(){alert("can not connect to server")}),v.on("rollback-complete",function(){s(),console.log("Receive Message: rollback complete! Add sensor listener")}),a(p.pinURL).then(function(t){p.pinsCount=t.length,n(),console.log(t),e(t)})});