"use strict";$(function(){function e(e){var n=e.length;$("#pin-total").text(n);var t=e.pop(),o=0;$("#pin").text(t),$("#pin-input").bind("GET_PIN",function(a){a.target.value!=t?(a.target.value="",$("#pin-form").addClass("has-error"),$(".form-control-feedback").removeClass("hidden"),p.emit("rollback",{pin:t,sampleID:d.sampleID}),r(),console.log("Wrong PIN! Send rollback message! Remove sensor listener")):(a.target.value="",$("#pin-form").removeClass("has-error"),$(".form-control-feedback").addClass("hidden"),t=e.pop(),o+=1,$("#pin-progress").css("width",o/n*100+"%"),$("#pin").text(t),$("#pin-count").text(o),o==n&&($("#pin-input").attr("disabled","disabled").unbind("GET_PIN"),p.emit("log-complete",{sampleID:d.sampleID,username:d.username,pinsCount:o,usparser:(new UAParser).getResult()}),$("#overModal").modal("show"),$("#enter-again-btn").click(function(e){window.location.reload()})))})}function n(){i(),t(),$("#pin-input").keyup(function(e){4==e.target.value.length&&$("#pin-input").trigger("GET_PIN",e)})}function t(){$("#startupModal").modal("show").on("hide.bs.modal",function(e){var n=$("#username").val();""!=n&&(d.username=n)})}function o(e){return new Promise(function(n,t){$.ajax({method:"GET",url:e,dataType:"jsonp"}).done(function(e){var t=a(e.pins);n(t)})})}function a(e){for(var n=1;n<e.length;n++){var t=Math.floor(Math.random()*(n+1)),o=e[n];e[n]=e[t],e[t]=o}return e}function i(){window.DeviceMotionEvent&&window.DeviceOrientationEvent?$("#pin-input").bind("focus",function(){c()}).bind("blur",function(){r()}):$("#browser-alert").removeClass("hidden")}function r(){window.removeEventListener("devicemotion",l,!1),window.removeEventListener("deviceorientation",u,!1)}function c(){window.addEventListener("devicemotion",l,!1),window.addEventListener("deviceorientation",u,!1)}function s(e){p.emit("sensor",{username:d.username,sampleID:d.sampleID,pin:$("#pin").text(),time:new Date,data:e})}function l(e){var n=e.acceleration,t=e.accelerationIncludingGravity,o=e.rotationRate,a=e.interval,i={"acc-x":n.x,"acc-y":n.y,"acc-z":n.z,"gacc-x":t.x,"gacc-y":t.y,"gacc-z":t.z,"rot-alpha":o.alpha,"rot-beta":o.beta,"rot-gamma":o.gamma,interval:a};s(i)}function u(e){var n={"ox-gamma":e.gamma,"oy-beta":e.beta,"oz-alpha":e.alpha};s(n)}var d={pinURL:"http://115.159.83.89:8080/pin",serverURL:"http://115.159.83.89:8080",username:"Anonymous",sampleID:(new Date).getTime()},p=io.connect(d.serverURL);p.on("connect_error",function(){console.error("can not connect to server")}),p.on("rollback-complete",function(){c(),console.log("Receive Message: rollback complete! Add sensor listener")}),o(d.pinURL).then(function(t){n(),console.log(t),e(t)})});