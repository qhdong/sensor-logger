"use strict";$(function(){function n(n){var e=n.length;$("#pin-total").text(e);var t=n.pop(),a=0;$("#pin").text(t),$("#pin-input").bind("GET_PIN",function(i){i.target.value!=t?(i.target.value="",$("#pin-form").addClass("has-error"),$(".form-control-feedback").removeClass("hidden"),m.emit("rollback",{pin:t,sampleID:u.sampleID}),r(),console.log("Wrong PIN! Send rollback message! Remove sensor listener")):(i.target.value="",$("#pin-form").removeClass("has-error"),$(".form-control-feedback").addClass("hidden"),t=n.pop(),a+=1,$("#pin-progress").css("width",a/e*100+"%"),$("#pin").text(t),$("#pin-count").text(a),a==e&&($("#pin-input").attr("disabled","disabled").unbind("GET_PIN"),o(),$("#overModal").modal("show"),$("#enter-again-btn").click(function(n){window.location.reload()})))})}function e(){i(),t();var n=$("#pin-input");n.attr("maxlength",u.pinLength).attr("minlength",u.pinLength).attr("pattern","d{"+u.pinLength+"}").attr("placeholder","Enter "+u.pinLength+" digit PIN."),n.keyup(function(n){n.target.value.length==u.pinLength&&$("#pin-input").trigger("GET_PIN",n)})}function t(){$("#startupModal").modal("show").on("hide.bs.modal",function(n){var e=$("#username").val();""!=e&&(u.username=e)})}function o(){m.emit("log-complete",{sampleID:u.sampleID,username:u.username,pinsCount:u.pinsCount,UAParser:d.getResult()})}function a(n){for(var e=1;e<n.length;e++){var t=Math.floor(Math.random()*(e+1)),o=n[e];n[e]=n[t],n[t]=o}return n}function i(){window.DeviceMotionEvent&&window.DeviceOrientationEvent?$("#pin-input").bind("focus",function(){c()}).bind("blur",function(){r()}):$("#browser-alert").removeClass("hidden")}function r(){window.removeEventListener("devicemotion",s,!1),window.removeEventListener("deviceorientation",p,!1)}function c(){window.addEventListener("devicemotion",s,!1),window.addEventListener("deviceorientation",p,!1)}function l(n){m.emit("sensor",{username:u.username,sampleID:u.sampleID,pin:$("#pin").text(),time:new Date,data:n})}function s(n){var e=n.acceleration,t=n.accelerationIncludingGravity,o=n.rotationRate,a=n.interval;l({"acc-x":e.x,"acc-y":e.y,"acc-z":e.z,"gacc-x":t.x,"gacc-y":t.y,"gacc-z":t.z,"rot-alpha":o.alpha,"rot-beta":o.beta,"rot-gamma":o.gamma,interval:a})}function p(n){l({"ox-gamma":n.gamma,"oy-beta":n.beta,"oz-alpha":n.alpha})}var u={pinURL:"http://115.159.83.89:1918/pin",serverURL:"http://115.159.83.89:1918",username:"Anonymous",sampleID:(new Date).getTime(),pinLength:1},d=new UAParser,m=io.connect(u.serverURL);m.on("connect_error",function(){alert("can not connect to server")}),m.on("rollback-complete",function(){c(),console.log("Receive Message: rollback complete! Add sensor listener")}),function(n){return new Promise(function(e,t){$.ajax({method:"GET",url:n,dataType:"jsonp"}).done(function(n){e(a(n.pins))})})}(u.pinURL).then(function(t){u.pinsCount=t.length,u.pinLength=t[0].length,e(),console.log(t),n(t)})});