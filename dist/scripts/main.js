"use strict";$(function(){function e(e){var n=e.length;$("#pin-total").text(n);var o=e.pop(),t=0;$("#pin").text(o),$("#pin-input").bind("GET_PIN",function(a){a.target.value!=o?(a.target.value="",$("#pin-form").addClass("has-error"),$(".form-control-feedback").removeClass("hidden"),m.emit("rollback",{pin:o,sampleID:u.sampleID}),r(),console.log("Wrong PIN! Send rollback message! Remove sensor listener")):(a.target.value="",$("#pin-form").removeClass("has-error"),$(".form-control-feedback").addClass("hidden"),o=e.pop(),t+=1,$("#pin-progress").css("width",t/n*100+"%"),$("#pin").text(o),$("#pin-count").text(t),t==n&&($("#pin-input").attr("disabled","disabled").unbind("GET_PIN"),m.emit("log-complete",{sampleID:u.sampleID,username:u.username}),$("#overModal").modal("show"),$("#enter-again-btn").click(function(e){window.location.reload()})))})}function n(){i(),o(),$("#pin-input").keyup(function(e){4==e.target.value.length&&$("#pin-input").trigger("GET_PIN",e)})}function o(){$("#startupModal").modal("show").on("hide.bs.modal",function(e){var n=$("#username").val();""!=n&&(u.username=n)})}function t(e){return new Promise(function(n,o){$.ajax({method:"GET",url:e,dataType:"jsonp"}).done(function(e){var o=a(e.pins);n(o)})})}function a(e){for(var n=1;n<e.length;n++){var o=Math.floor(Math.random()*(n+1)),t=e[n];e[n]=e[o],e[o]=t}return e}function i(){window.DeviceMotionEvent&&window.DeviceOrientationEvent?$("#pin-input").bind("focus",function(){c()}).bind("blur",function(){r()}):$("#browser-alert").removeClass("hidden")}function r(){window.removeEventListener("devicemotion",s,!1),window.removeEventListener("deviceorientation",d,!1)}function c(){window.addEventListener("devicemotion",s,!1),window.addEventListener("deviceorientation",d,!1)}function l(e){m.emit("sensor",{username:u.username,sampleID:u.sampleID,pin:$("#pin").text(),time:new Date,data:e})}function s(e){var n=e.acceleration,o=e.accelerationIncludingGravity,t=e.rotationRate,a=e.interval,i={"acc-x":n.x,"acc-y":n.y,"acc-z":n.z,"gacc-x":o.x,"gacc-y":o.y,"gacc-z":o.z,"rot-alpha":t.alpha,"rot-beta":t.beta,"rot-gamma":t.gamma,interval:a};l(i)}function d(e){var n={"ox-gamma":e.gamma,"oy-beta":e.beta,"oz-alpha":e.alpha};l(n)}var u={pinURL:"http://115.159.83.89:8080/pin",serverURL:"http://115.159.83.89:8080",username:"Anonymous",sampleID:(new Date).getTime()},m=io.connect(u.serverURL);m.on("connect_error",function(){console.error("can not connect to server")}),m.on("rollback-complete",function(){c(),console.log("Receive Message: rollback complete! Add sensor listener")}),t(u.pinURL).then(function(o){n(),console.log(o),e(o)})});